# 背景知识：高频市场微结构

> "在毫秒级别，市场不是随机游走，而是一场买卖双方的博弈。"

---

## 什么是市场微结构？

**传统视角**：股价由基本面决定——财报、宏观经济、行业趋势

**微结构视角**：股价由订单流决定——谁在买、谁在卖、用什么价格挂单

```
时间尺度对比：

基本面分析：月 → 年
技术分析：日 → 周
市场微结构：毫秒 → 秒
```

---

## 核心概念：订单簿

**订单簿（Order Book）**：当前所有未成交的买卖挂单

![订单簿结构](assets/order-book.svg)

### 关键术语

| 术语 | 定义 | 意义 |
|-----|------|------|
| Bid（买一） | 最高买价 | 现在能卖出的最高价 |
| Ask（卖一） | 最低卖价 | 现在能买入的最低价 |
| Spread（价差） | Ask - Bid | 交易的隐性成本 |
| Mid（中间价） | (Bid + Ask) / 2 | 公允价格估计 |
| Depth（深度） | 各价位挂单量 | 市场承接能力 |

---

## 订单类型

### 市价单（Market Order）

```
指令："立即买入 100 股，不管什么价格"

执行：
  - 按当前卖一价 $185.35 成交
  - 如果卖一只有 50 股，剩余 50 股按卖二 $185.40 成交

优点：确保成交
缺点：可能滑点（价格不利）
```

### 限价单（Limit Order）

```
指令："以 $185.30 或更低价格买入 100 股"

执行：
  - 如果当前有 ≤$185.30 的卖单 → 立即成交
  - 否则 → 挂入订单簿等待

优点：控制价格
缺点：可能不成交
```

### 其他订单类型

| 类型 | 作用 | 场景 |
|-----|------|------|
| Stop（止损单） | 价格触发后变市价单 | 风控 |
| Stop-Limit | 价格触发后变限价单 | 更精细止损 |
| IOC（立即或取消） | 能成交多少成交多少 | 紧急执行 |
| FOK（全部或取消） | 全部成交或全不成交 | 避免部分成交 |
| Iceberg（冰山单） | 只显示部分挂单量 | 隐藏大单意图 |

---

## 买卖价差的含义

### 价差来源

| 成分 | 解释 | 占比 |
|-----|------|------|
| 存货成本 | 做市商持有库存的风险补偿 | 20-30% |
| 逆向选择 | 防范知情交易者的损失 | 40-50% |
| 订单处理成本 | 交易系统和人力成本 | 10-20% |

**逆向选择**是关键：做市商担心与知情交易者交易时亏损

```
场景：
  某人知道苹果即将发布利好，悄悄大量买入
  做市商不知情，以低价卖给他
  消息公布后，做市商亏损

应对：
  做市商通过扩大价差来弥补这种预期亏损
```

### 价差与流动性

```
流动性好：
  - 价差小（$0.01）
  - 挂单量大
  - 大单不影响价格
  - 代表：AAPL、MSFT、SPY

流动性差：
  - 价差大（$0.10+）
  - 挂单量小
  - 大单显著影响价格
  - 代表：小盘股、冷门 ETF
```

---

## 市场影响（Market Impact）

**定义**：你的交易对价格的影响

```
你想买入 10,000 股 AAPL
当前订单簿：
  卖一：$185.35 × 200 股
  卖二：$185.40 × 300 股
  卖三：$185.45 × 500 股
  ...

如果一次性买入：
  成交 200 @ $185.35
  成交 300 @ $185.40
  成交 500 @ $185.45
  ...

平均成交价可能是 $185.60
比中间价高 $0.25 → 市场影响成本
```

### 影响因素

| 因素 | 影响 | 原因 |
|-----|------|------|
| 订单大小 | 越大影响越大 | 消耗更多深度 |
| 市场流动性 | 流动性差影响更大 | 挂单薄 |
| 执行速度 | 越快影响越大 | 无法隐藏意图 |
| 信息含量 | 知情交易影响更持久 | 价格发现 |

### 市场影响模型

```
简化的平方根法则：

市场影响 ≈ σ × √(Q / V)

其中：
  σ = 日波动率
  Q = 交易数量
  V = 日均成交量

示例：
  波动率 = 2%
  交易量 = 日均成交量的 1%

  影响 ≈ 2% × √0.01 = 0.2%
```

---

## 做市商的角色

**做市商**：同时挂买单和卖单，赚取价差

```
做市商策略：
  挂买单 @ $185.30
  挂卖单 @ $185.35

  如果两边都成交：
    卖出价 - 买入价 = $0.05 利润

  风险：
    只有一边成交 → 暴露库存风险
    方向性行情 → 亏损
```

### 做市商 vs 方向性交易者

| 维度 | 做市商 | 方向性交易者 |
|-----|-------|------------|
| 目标 | 赚价差 | 赚价格变动 |
| 持仓时间 | 极短（秒/分钟） | 较长（小时/天） |
| 风险敞口 | 尽量中性 | 有方向敞口 |
| 盈利来源 | 价差 − 逆向选择 − 库存成本 | 预测准确性 |

---

## 价格发现过程

**价格发现**：市场如何把信息反映到价格中

```
信息发布 → 知情交易者下单 → 订单流变化 → 价格调整

时间线示例：
  T+0ms：利好消息发布
  T+1ms：高速交易者检测到消息
  T+5ms：大量买单涌入
  T+10ms：卖一被吃掉，价格上涨
  T+100ms：价格基本反映新信息
  T+1000ms：普通投资者看到价格变化
```

### 订单流毒性

**毒性订单流**：知情交易者主导的订单流

```
指标：VPIN（Volume-Synchronized Probability of Informed Trading）

高 VPIN → 知情交易者活跃 → 做市商风险大
低 VPIN → 噪音交易者主导 → 做市商安全

应用：
  - 做市商根据 VPIN 调整价差
  - 预警市场压力（高 VPIN 可能预示暴跌）
```

---

## 高频交易策略类别

| 策略类型 | 描述 | 盈利来源 |
|---------|------|---------|
| 做市 | 双向挂单赚价差 | 价差收益 − 逆向选择 − 库存风险 |
| 统计套利* | 利用价格偏离均值回归 | 价格失调修正 |
| 新闻交易 | 快速解读新闻（毫秒至分钟级） | 信息优势 |
| 延迟套利 | 利用交易所间延迟 | 速度优势 |
| 结构套利 | 利用市场结构机制（返佣、集合竞价、ETF申赎等） | 系统理解 |

> **\* 关于统计套利**：统计套利并非高频专属策略。按持仓周期可分为：
> - **高频统计套利**（毫秒～秒）：跨交易所微结构信号
> - **日内统计套利**（分钟～小时）：配对交易、ETF-成分股套利
> - **中低频统计套利**（天～周）：多因子、行业中性策略
>
> 是否需要高频取决于：**信号衰减速度 vs 交易成本**。信号衰减快才"被迫"高频。

**延迟套利示例**：

```
NYSE 价格：$185.35
BATS 价格：$185.30（延迟更新）

策略：
  在 BATS 买入 @ $185.30
  在 NYSE 卖出 @ $185.35
  理论价差 $0.05

⚠️ 现实风险：
  - 腿风险：可能只成交一边
  - 排队风险：挂到的价未必轮到成交
  - 逆向选择：价格瞬间反向变化
  - 费用/滑点：可能吃掉利润

前提：速度比其他人快，且利润需覆盖费用与滑点
```

---

## 交易成本分解

一笔交易的总成本（2024-2025）：

```
总成本 = 显性成本 + 隐性成本

显性成本：
  - 佣金：零（零售券商，2019年后）
        或 ~$0.003-0.005/股（机构投资者）
  - 交易所费用（$0.003/股，make/take 费率因交易所而异）
  - SEC 费（~$27.80/百万美元卖出）

隐性成本：
  - 买卖价差（$0.01-0.02/股）
  - 市场影响（$0.02-0.10/股，视订单大小）
  - 时机成本（决策到执行的价格变化）
  - PFOF 执行质量损失（零佣金的代价）

示例（零售）：
  买入 1,000 股 @ $230
  佣金：$0（但有 PFOF）
  价差成本：$10-20
  影响成本：$20-50

  总成本：$30-70 ≈ 0.02-0.03%
```

> **零佣金模式注意**：券商通过 PFOF（订单流支付）将订单卖给做市商，可能导致执行价格略差于 NBBO。

---

## 多智能体视角

市场微结构知识在多智能体架构中的应用：

```
Execution Agent（执行智能体）
  │
  ├─ 监控订单簿深度
  ├─ 评估市场影响成本
  ├─ 决定执行策略：
  │    - 大单 → 分批执行
  │    - 小单 → 立即执行
  │    - 紧急 → 接受滑点
  │
  ↓
Risk Agent
  │
  ├─ 监控 VPIN 等毒性指标
  ├─ 高毒性时暂停交易
  └─ 流动性枯竭时发出预警

Market State Agent（市场状态）
  │
  ├─ 追踪价差变化
  ├─ 识别流动性 Regime
  └─ 调整策略参数
```

---

## 常见误区

**误区一：成交价就是真实成本**

不完整。真实成本包括：
- 你把价格推高的部分（影响成本）
- 你挂单等待时价格变化的部分（时机成本）

**误区二：流动性总是可用的**

危机时流动性消失：
- 做市商撤单
- 价差急剧扩大
- 订单无法成交

2010 年闪崩时，部分股票价差扩大到几美元。

**误区三：高频交易都是操纵**

大部分高频策略是提供流动性：
- 做市商缩小价差
- 套利者消除价格偏离
- 增加市场效率

当然也存在掠夺性策略，但不是全部。

---

## 实用建议

### 对低频交易者

```
1. 避免市价单大额交易
   - 分批执行
   - 使用限价单

2. 避开高波动时段
   - 开盘和收盘半小时价差大
   - 重大新闻发布时流动性差

3. 关注流动性
   - 单笔交易量 < 日均成交量的 1%
   - 否则市场影响成本过高
```

### 对策略开发者

```
1. 在回测中加入真实成本
   - 不只是佣金
   - 包括价差和影响

2. 监控成交量
   - 策略容量 = 日均成交量的 1-5%
   - 超过后收益显著下降

3. 使用滑点模型
   - 简单：固定百分比滑点
   - 进阶：基于订单簿模拟
```

---

## 总结

| 要点 | 说明 |
|-----|------|
| 核心概念 | 订单簿、买卖价差、市场深度 |
| 关键成本 | 价差 + 市场影响 + 时机成本 |
| 做市商角色 | 提供流动性，赚取价差 |
| 价格发现 | 订单流反映信息 |
| 多智能体应用 | Execution Agent 优化执行 |
